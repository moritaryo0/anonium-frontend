# Cloudflare Pages デプロイ設定ガイド

## ビルド設定

Cloudflare Pagesダッシュボードで以下の設定を行ってください：

### 基本設定

- **Framework preset**: `Next.js (Static HTML Export)` または `None`
- **Build command**: `npm run pages:build`
- **Build output directory**: `.vercel/output/static`
- **Root directory**: `/frontend` (リポジトリのルートがプロジェクトルートの場合)

### 環境変数

Cloudflare Pagesダッシュボードの「設定」→「環境変数」で以下を設定：

詳細は [ENV_EXAMPLE.md](./ENV_EXAMPLE.md) を参照してください。

#### 本番環境
```
NEXT_PUBLIC_API_BASE_URL=https://api.yourdomain.com
ALLOWED_ORIGINS=https://yourdomain.com,https://www.yourdomain.com
```

#### プレビュー環境
```
NEXT_PUBLIC_API_BASE_URL=https://api-staging.yourdomain.com
ALLOWED_ORIGINS=https://preview.yourdomain.com
```

### 互換性フラグ

`functions/wrangler.toml`で設定済み：
- `nodejs_compat`
- `nodejs_compat_populate_process_env`

Cloudflare Pagesダッシュボードでも確認：
1. 「設定」→「Functions」→「Compatibility Flags」
2. 上記のフラグが有効になっていることを確認

## デプロイ手順

### 初回デプロイ

1. GitHubリポジトリをCloudflare Pagesに接続
2. ビルド設定を上記の通り設定
3. 環境変数を設定
4. 「保存してデプロイ」をクリック

### 自動デプロイ

- プッシュ時に自動デプロイされます
- プルリクエストごとにプレビューデプロイが作成されます

## トラブルシューティング

### ビルドエラー

1. `package-lock.json`が最新であることを確認
2. `.npmrc`に`legacy-peer-deps=true`が設定されていることを確認
3. Node.jsバージョンが22.xであることを確認

### ランタイムエラー

1. 環境変数が正しく設定されているか確認
2. `functions/_worker.js`が正しく配置されているか確認
3. Cloudflare Pagesのログを確認

## パフォーマンス最適化

- Edge Runtimeを使用（動的ルート）
- 画像最適化が有効
- Gzip圧縮が有効
- セキュリティヘッダーが設定済み

## セキュリティ

- セキュリティヘッダーが自動的に追加されます
- CORS設定は環境変数で制御可能
- JWT認証はCookieベースで安全

