# Cloudflare Pages デプロイ設定ガイド

## ビルド設定

Cloudflare Pagesダッシュボードで以下の設定を行ってください：

### 基本設定

- **Framework preset**: `Next.js (Static HTML Export)` または `None`
- **Build command**: `npm run pages:build`
- **Build output directory**: `.vercel/output/static`
- **Root directory**: `/frontend` (リポジトリのルートがプロジェクトルートの場合)
- **Deploy command**: `npx wrangler pages deploy .vercel/output/static --project-name=anonium-frontend`

**注意**: デプロイコマンドが必須の場合、上記のコマンドを使用してください。`wrangler`は`devDependencies`に含まれています。

### 環境変数

Cloudflare Pagesダッシュボードの「設定」→「環境変数」で以下を設定：

詳細は [ENV_EXAMPLE.md](./ENV_EXAMPLE.md) を参照してください。

#### 本番環境
```
NEXT_PUBLIC_API_BASE_URL=https://api.yourdomain.com
ALLOWED_ORIGINS=https://yourdomain.com,https://www.yourdomain.com
```

#### プレビュー環境
```
NEXT_PUBLIC_API_BASE_URL=https://api-staging.yourdomain.com
ALLOWED_ORIGINS=https://preview.yourdomain.com
```

### 互換性フラグ

互換性フラグは以下の2つの方法で設定できます：

#### 方法1: `wrangler.toml`ファイル（推奨）

プロジェクトルート（`frontend/wrangler.toml`）に設定済み：
- `nodejs_compat`
- `nodejs_compat_populate_process_env`

このファイルは自動的に読み込まれます。

#### 方法2: Cloudflare Pagesダッシュボード

1. 「設定」→「Functions」→「Compatibility Flags」
2. 以下のフラグを追加：
   - `nodejs_compat`
   - `nodejs_compat_populate_process_env`
3. 「保存」をクリック

**注意**: 警告が表示される場合は、上記のいずれかの方法でフラグを有効化してください。

## デプロイ手順

### 初回デプロイ

1. GitHubリポジトリをCloudflare Pagesに接続
2. ビルド設定を上記の通り設定
3. 環境変数を設定
4. 「保存してデプロイ」をクリック

### 自動デプロイ

- プッシュ時に自動デプロイされます
- プルリクエストごとにプレビューデプロイが作成されます

## トラブルシューティング

### デプロイコマンドエラー

**エラー**: `✘ [ERROR] Missing entry-point to Worker script or to assets directory`

**原因**: Cloudflare Pagesの設定で「Deploy command」に`npx wrangler deploy`が設定されている（これはCloudflare Workers用のコマンドです）

**解決方法**:
1. Cloudflare Pagesダッシュボードにログイン
2. プロジェクトの「設定」→「ビルドとデプロイ」を開く
3. 「Deploy command」フィールドを以下のコマンドに変更：
   ```
   npx wrangler pages deploy .vercel/output/static --project-name=anonium-frontend
   ```
4. 「保存」をクリック
5. 新しいデプロイを実行

**重要**: `wrangler deploy`ではなく、`wrangler pages deploy`を使用してください。Cloudflare Pages用のコマンドです。

### ビルドエラー

1. `package-lock.json`が最新であることを確認（`npm install`を実行）
2. `.npmrc`に`legacy-peer-deps=true`が設定されていることを確認
3. Node.jsバージョンが20以上であることを確認（`.nvmrc`ファイルで指定）

### ランタイムエラー

1. 環境変数が正しく設定されているか確認
2. `functions/_worker.js`が正しく配置されているか確認
3. 互換性フラグ（`nodejs_compat`）が有効になっているか確認
4. Cloudflare Pagesのログを確認

### `nodejs_compat`警告

「Your Worker may throw errors at runtime unless you enable the "nodejs_compat" compatibility flag」という警告が表示される場合：

1. **プロジェクトルートの`wrangler.toml`を確認**
   - `frontend/wrangler.toml`に`nodejs_compat`が設定されているか確認

2. **Cloudflare Pagesダッシュボードで設定**
   - 「設定」→「Functions」→「Compatibility Flags」
   - `nodejs_compat`と`nodejs_compat_populate_process_env`を追加
   - 「保存」をクリック

3. **再デプロイ**
   - 設定変更後、新しいデプロイを実行

## パフォーマンス最適化

- Edge Runtimeを使用（動的ルート）
- 画像最適化が有効
- Gzip圧縮が有効
- セキュリティヘッダーが設定済み

## セキュリティ

- セキュリティヘッダーが自動的に追加されます
- CORS設定は環境変数で制御可能
- JWT認証はCookieベースで安全

